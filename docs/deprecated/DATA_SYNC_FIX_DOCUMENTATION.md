# Data Sync Fixes Documentation

**Date:** December 1, 2025  
**Author:** GitHub Copilot (assisted debugging and fixes)  
**Purpose:** Document the fixes made to resolve data display issues on the portfolio website after switching to static builds from Airtable.

## Problem Summary

The portfolio website was not displaying any project data after implementing static builds from Airtable. The local development server showed empty project lists, and the production site (fetching from Cloudinary) also failed to show data.

## Root Cause Analysis

The issues stemmed from problems in the data synchronization process:

### Issue #1: Schema Mismatch
- **Original Schema** (expected by the frontend): Projects with fields like `type`, `kinds`, `genre`, `heroImage`, `gallery`, `videoUrl`, `isFeatured`, `isHero`
- **New Schema** (being generated by sync script): Projects with fields like `category`, `role`, `images`
- The sync script in `scripts/lib/sync-core.mjs` was outputting the new schema format instead of the original one that the React components were expecting.

### Issue #2: Missing Video Thumbnail Fallback
- **Original Behavior** (in `cmsService.backup.ts`): When a project had no gallery images but had a video URL, the video thumbnail was automatically fetched and used as the `heroImage`
- **Broken Behavior** (in initial `sync-core.mjs`): Projects without gallery images would have an empty `heroImage`, even if they had a video URL
- This affected 19 projects that rely on video thumbnails as their primary visual

## Changes Made

### 1. Schema Correction in `scripts/lib/sync-core.mjs`

Updated the `processProjectRecords` function to output the original schema format:

- **Field Mappings Corrected:**
  - `type`: Mapped from `Project Type` field
  - `kinds`: Mapped from `Kind` or `Kinds` field (array)
  - `genre`: Mapped from `Genre` field (array)
  - `heroImage`: Set to first image from `gallery` (derived from `Gallery` or `Gallery (Image)` field)
  - `gallery`: Array of image URLs from `Gallery` attachments, preferring Cloudinary URLs when available
  - `videoUrl`: Mapped from `Video URL` field, with fallback to parsed videos from `External Links`
  - `isFeatured`: Set to true if `Display Status` is 'Featured' or 'Hero'
  - `isHero`: Set to true if `Display Status` is 'Hero'
  - `description`: Mapped from `About` or `Description` field
  - `awards`: Resolved from `Festivals` or `Awards` field using festival lookup
  - `credits`: Parsed from `Credits (new)` or `Credits` field
  - `productionCompany`: Resolved from `Production Company` field
  - `client`: Mapped from `Client` field
  - `year`: Extracted from `Release Date` or `Work Date`
  - `releaseDate` and `workDate`: Mapped directly
  - `externalLinks`: Parsed from `External Links` field

### 2. Video Thumbnail Fallback Logic

Restored the missing video thumbnail fallback functionality:
- When a project has no gallery images but has a `videoUrl`, fetch the video thumbnail using `getVideoThumbnail()`
- Use the fetched thumbnail as the `heroImage` so projects display correctly
- Handles both YouTube (`img.youtube.com`) and Vimeo (`i.vimeocdn.com`) thumbnails
- Gracefully handles errors with warning logs in verbose mode
### 4. Data Synchronization and Upload

- Performed full sync with `FORCE_FULL_SYNC=true npm run build:data`
- Uploaded corrected data to Cloudinary using `node scripts/sync-static-to-cloudinary.mjs`
- Verified data structure, sorting order, and video thumbnail fallbacks
  try {
    const videoThumbnail = await getVideoThumbnail(finalVideoUrl);
    heroImage = videoThumbnail || '';
  } catch (err) {
    if (verbose) console.warn(`Failed to fetch video thumbnail for ${title}`);
  }
}
```

### 3. Sorting Implementation

Added proper chronological sorting of projects:
- Primary sort: `Release Date` (if available)
- Secondary sort: `Work Date` (fallback)
- Order: Newest first (descending)

### 3. Data Synchronization and Upload

- Performed full sync with `FORCE_FULL_SYNC=true npm run build:data`
- Uploaded corrected data to Cloudinary using `node scripts/sync-static-to-cloudinary.mjs`
- Verified data structure and sorting order

## Files Modified

- `scripts/lib/sync-core.mjs`: Updated `processProjectRecords` function with correct field mappings and sorting logic

## Verification Steps

1. **Local Development Server:** Confirmed projects display correctly with proper sorting
2. **Data Structure Check:** Verified Cloudinary-hosted `portfolio-data.json` contains expected fields
3. **Sorting Verification:** Confirmed projects are ordered newest-first by release/work date
4. **Field Completeness:** Checked that all Airtable fields are properly mapped (heroImage, gallery, videoUrl, etc.)
5. **Video Thumbnail Fallback:** Verified 19 projects without gallery images now have video thumbnails as heroImage
   - YouTube thumbnails: `https://img.youtube.com/vi/{id}/maxresdefault.jpg`
   - Vimeo thumbnails: `https://i.vimeocdn.com/video/{id}-{hash}.jpg`

## Commands Executed

```bash
# Force full sync with corrected logic
FORCE_FULL_SYNC=true npm run build:data

# Upload to Cloudinary for production-like behavior
node scripts/sync-static-to-cloudinary.mjs

# Check specific project fields
curl -s "https://res.cloudinary.com/date24ay6/raw/upload/portfolio-static/portfolio-data.json" | node -e 'const data = JSON.parse(require("fs").readFileSync(0, "utf-8")); const p = data.projects.find(x => x.slug === "diesel-express-yourself"); console.log("heroImage:", p.heroImage ? "✅" : "❌"); console.log("gallery:", p.gallery?.length || 0, "images"); console.log("videoUrl:", p.videoUrl ? "✅" : "❌");'

# Verify video thumbnail fallbacks
## Results

- **Projects Synced:** 39 projects
- **Journal Posts:** 1 post
- **Data File Size:** 550.68 KB
- **API Calls:** 12 (full sync)
- **Sorting:** Verified newest projects first (2025 dates appear before older ones)
- **Video Thumbnails:** 19 projects now have video thumbnails as heroImage (previously empty)ength);
projectsWithVideoOnly.slice(0, 3).forEach(p => {
  console.log(`  ${p.title}: ${p.heroImage ? "✅" : "❌"}`);
});
'
```
# Check specific project fields
curl -s "https://res.cloudinary.com/date24ay6/raw/upload/portfolio-static/portfolio-data.json" | node -e 'const data = JSON.parse(require("fs").readFileSync(0, "utf-8")); const p = data.projects.find(x => x.slug === "diesel-express-yourself"); console.log("heroImage:", p.heroImage ? "✅" : "❌"); console.log("gallery:", p.gallery?.length || 0, "images"); console.log("videoUrl:", p.videoUrl ? "✅" : "❌");'
```
## Key Lessons Learned

- Airtable field names must exactly match what's configured in the base (e.g., 'Gallery' vs 'Gallery (Image)')
- Schema changes require careful mapping to maintain frontend compatibility
- When migrating from dynamic API fetching to static data generation, **all existing behaviors must be preserved**, including:
  - Video thumbnail fallbacks for projects without gallery images
  - Async operations (e.g., `fetchVideoThumbnail()` must remain async)
  - Error handling for external API calls (Vimeo OEmbed, YouTube, etc.)
- Local development should mirror production data sources (Cloudinary) for accurate testing
- Full sync is necessary when changing data processing logic
- Sorting logic should be clearly documented and tested
- Always check the backup/original implementation (`cmsService.backup.ts`) for reference when refactoring
- **Sorting:** Verified newest projects first (2025 dates appear before older ones)

## Next Steps for Future Agents

1. **Deploy to Production:** Push changes to Netlify to verify live site works with Cloudinary data
2. **Monitor Sync Process:** Set up alerts for sync failures or unexpected schema changes
3. **Schema Validation:** Consider adding automated tests to ensure schema consistency
4. **Documentation Updates:** Update any frontend component docs if schema expectations change
5. **Incremental Sync Testing:** Verify incremental sync doesn't break with future Airtable updates

## Key Lessons Learned

- Airtable field names must exactly match what's configured in the base (e.g., 'Gallery' vs 'Gallery (Image)')
- Schema changes require careful mapping to maintain frontend compatibility
- Local development should mirror production data sources (Cloudinary) for accurate testing
- Full sync is necessary when changing data processing logic
- Sorting logic should be clearly documented and tested

## Contact Information

If issues arise with data sync or schema changes, refer to this document and check:
- `scripts/lib/sync-core.mjs` for data processing logic
- `services/cmsService.ts` for data fetching behavior
- Airtable base for field name accuracy
- Cloudinary dashboard for uploaded data verification