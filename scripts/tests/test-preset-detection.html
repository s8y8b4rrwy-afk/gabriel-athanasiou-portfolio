<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudinary Preset Detection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #0a0a0a;
            color: #e0e0e0;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .result {
            font-family: monospace;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 4px;
            margin: 10px 0;
        }
        .preset-ultra { color: #4ade80; }
        .preset-fine { color: #fbbf24; }
        h1 { color: #fff; border-bottom: 2px solid #333; padding-bottom: 10px; }
        h2 { color: #a0a0a0; font-size: 18px; margin-top: 0; }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <h1>üéØ Cloudinary Preset Detection Test</h1>
    
    <div class="test-section">
        <h2>Current Device Detection</h2>
        <div id="deviceInfo" class="result"></div>
        <div id="presetResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Session Storage Test</h2>
        <button onclick="testSessionStorage()">Test Session Cache</button>
        <button onclick="clearSession()">Clear Session</button>
        <div id="sessionResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Network Conditions Test</h2>
        <div id="networkInfo" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Expected Transformation URL</h2>
        <div id="urlExample" class="result" style="word-break: break-all;"></div>
    </div>

    <script>
        // Simplified version of the detection logic from imageOptimization.ts
        function detectOptimalPreset() {
            // Check network conditions
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                if (connection.saveData || connection.effectiveType === '2g') {
                    console.log('üåê Network: Slow connection detected, using fine preset');
                    return 'fine';
                }
            }

            // Check viewport size and DPR
            const viewportWidth = window.innerWidth;
            const dpr = window.devicePixelRatio || 1;
            const effectiveWidth = viewportWidth * dpr;

            if (effectiveWidth >= 1024) {
                console.log(`üñ•Ô∏è Device: ${viewportWidth}px √ó ${dpr} DPR = ${effectiveWidth}px effective, using ultra preset`);
                return 'ultra';
            }

            console.log(`üì± Device: ${viewportWidth}px √ó ${dpr} DPR = ${effectiveWidth}px effective, using fine preset`);
            return 'fine';
        }

        function getSessionPreset() {
            const STORAGE_KEY = 'cloudinary_preset';
            const cached = sessionStorage.getItem(STORAGE_KEY);
            if (cached === 'ultra' || cached === 'fine') {
                return cached;
            }
            const preset = detectOptimalPreset();
            sessionStorage.setItem(STORAGE_KEY, preset);
            return preset;
        }

        function displayDeviceInfo() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const dpr = window.devicePixelRatio || 1;
            const effectiveWidth = viewportWidth * dpr;
            
            document.getElementById('deviceInfo').innerHTML = `
                <strong>Viewport:</strong> ${viewportWidth}px √ó ${viewportHeight}px<br>
                <strong>Device Pixel Ratio:</strong> ${dpr}x<br>
                <strong>Effective Width:</strong> ${effectiveWidth}px<br>
                <strong>Threshold:</strong> 1024px (effective)
            `;
        }

        function displayPresetResult() {
            const preset = getSessionPreset();
            const quality = preset === 'ultra' ? 90 : 75;
            const presetClass = `preset-${preset}`;
            
            document.getElementById('presetResult').innerHTML = `
                <strong>Selected Preset:</strong> <span class="${presetClass}">${preset.toUpperCase()}</span><br>
                <strong>Quality Value:</strong> ${quality}%<br>
                <strong>Logic:</strong> ${window.innerWidth * (window.devicePixelRatio || 1) >= 1024 ? 'Desktop/High-res ‚Üí ultra' : 'Mobile/Low-res ‚Üí fine'}
            `;
        }

        function displayNetworkInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                document.getElementById('networkInfo').innerHTML = `
                    <strong>Connection Type:</strong> ${connection.effectiveType || 'unknown'}<br>
                    <strong>Save Data:</strong> ${connection.saveData ? 'Enabled (forces fine preset)' : 'Disabled'}<br>
                    <strong>Downlink:</strong> ${connection.downlink || 'unknown'} Mbps<br>
                    <strong>RTT:</strong> ${connection.rtt || 'unknown'} ms
                `;
            } else {
                document.getElementById('networkInfo').innerHTML = `
                    <strong>Network Information API:</strong> Not supported in this browser
                `;
            }
        }

        function displayExampleURL() {
            const preset = getSessionPreset();
            const quality = preset === 'ultra' ? 90 : 75;
            const exampleURL = `https://res.cloudinary.com/date24ay6/image/upload/f_webp,w_1600,c_limit,dpr_auto,q_${quality}/portfolio-projects-recABC123-0`;
            
            document.getElementById('urlExample').innerHTML = `
                <strong>Sample Cloudinary URL:</strong><br>
                ${exampleURL}<br><br>
                <strong>Transformations:</strong><br>
                ‚Ä¢ Format: webp<br>
                ‚Ä¢ Width: 1600px<br>
                ‚Ä¢ Crop: limit (no upscaling)<br>
                ‚Ä¢ DPR: auto<br>
                ‚Ä¢ Quality: ${quality} (${preset} preset)
            `;
        }

        function testSessionStorage() {
            const result = document.getElementById('sessionResult');
            const preset1 = getSessionPreset();
            const preset2 = getSessionPreset();
            const cached = sessionStorage.getItem('cloudinary_preset');
            
            result.innerHTML = `
                <strong>‚úÖ Session Storage Test:</strong><br>
                First call: ${preset1}<br>
                Second call: ${preset2}<br>
                Cached value: ${cached}<br>
                <strong>Result:</strong> ${preset1 === preset2 && preset1 === cached ? '‚úÖ Working correctly' : '‚ùå Cache mismatch'}
            `;
        }

        function clearSession() {
            sessionStorage.removeItem('cloudinary_preset');
            document.getElementById('sessionResult').innerHTML = `
                <strong>Session cleared.</strong> Reload page to detect again.
            `;
        }

        // Run tests on load
        window.addEventListener('load', () => {
            displayDeviceInfo();
            displayPresetResult();
            displayNetworkInfo();
            displayExampleURL();
        });

        // Re-run on resize to show responsive behavior
        window.addEventListener('resize', () => {
            sessionStorage.removeItem('cloudinary_preset'); // Clear to re-detect
            displayDeviceInfo();
            displayPresetResult();
            displayExampleURL();
        });
    </script>
</body>
</html>
