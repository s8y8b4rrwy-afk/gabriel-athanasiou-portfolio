[build]
# Build command uses custom script that reads PORTFOLIO_MODE environment variable
# For directing site: set PORTFOLIO_MODE=directing in Netlify env vars
# For postprod site: set PORTFOLIO_MODE=postproduction in Netlify env vars
command = "bash scripts/netlify-build.sh"
functions = "netlify/functions"
publish = "dist"
# Build optimization: Only build production branch and deploy previews
# Feature branches will not auto-build unless you enable them specifically
ignore = "bash scripts/ignore-netlify-build.sh"

# Configure functions to include sharp for image processing
[functions]
  node_bundler = "esbuild"
  # Don't bundle sharp - let it run as external
  external_node_modules = ["sharp", "@img/sharp-linux-x64", "@img/sharp-libvips-linux-x64"]

# Enable Netlify Blobs and KV storage
[context.production]
  [context.production.environment]
    NETLIFY_BLOBS_CONTEXT = "production"

# Cache optimized images between builds
[[plugins]]
  package = "netlify-plugin-cache"
  [plugins.inputs]
    paths = ["dist/images/portfolio", "public/images/portfolio"]

# Browser caching for static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[dev]
command = "npm run dev:vite"
targetPort = 3000
port = 8888
autoLaunch = false

# Redirect /sitemap.xml to the dynamic sitemap function
[[redirects]]
from = "/sitemap.xml"
to = "/.netlify/functions/sitemap"
status = 200
force = true

# SPA fallback - the edge function will intercept specific routes via its config export
[[redirects]]
from = "/*"
to = "/index.html"
status = 200
