[build]
command = "npm run build"
functions = "netlify/functions"
publish = "dist"
 # Only build when commit message contains [deploy] or [force-deploy]
 ignore = "bash scripts/ignore-netlify-build.sh"

# Configure functions to include sharp for image processing
[functions]
  node_bundler = "esbuild"
  # Don't bundle sharp - let it run as external
  external_node_modules = ["sharp", "@img/sharp-linux-x64", "@img/sharp-libvips-linux-x64"]

# Enable Netlify Blobs and KV storage
[context.production]
  [context.production.environment]
    NETLIFY_BLOBS_CONTEXT = "production"

# Cache optimized images between builds
[[plugins]]
  package = "netlify-plugin-cache"
  [plugins.inputs]
    paths = ["dist/images/portfolio", "public/images/portfolio"]

# Browser caching for static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[dev]
targetPort = 3000
port = 8888

# Edge Functions for dynamic meta tag injection
[[edge_functions]]
path = "/work/*"
function = "meta-rewrite"

[[edge_functions]]
path = "/journal/*"
function = "meta-rewrite"

# Redirect /sitemap.xml to the dynamic sitemap function
[[redirects]]
from = "/sitemap.xml"
to = "/.netlify/functions/sitemap"
status = 200
force = true

# SPA fallback (must be last)
[[redirects]]
from = "/*"
to = "/index.html"
status = 200
